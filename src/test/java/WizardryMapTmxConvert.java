
import andius.Andius;
import andius.objects.Icons;
import andius.objects.Monster;
import com.badlogic.gdx.ApplicationListener;
import com.badlogic.gdx.backends.lwjgl.LwjglApplication;
import java.awt.Dimension;
import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.Random;

import jakarta.xml.bind.DatatypeConverter;
import org.apache.commons.io.FileUtils;

public class WizardryMapTmxConvert implements ApplicationListener {

    public static final String L1 = "555555555500545500040800500000007400005540914500005500944D00501440064000144040066400004000500300001440550100555546555500000001008100545551555500505550559900705550551500B09A50559A00301050550000605750B5990040555001000050155099590054154010400001005414640005005518540015015514A400150254804200150155149400094495105400458454140400494455040400450055020C0001000100410000000404000005002400000055551500D00055D52500D000956015005400952025007500550054581500150025581600054055D3C400010055D3C4005455000C040050000000740000554091450000550094C50050144006400014404006E40000400050010000144055010055554655550000000100810055555155550050555055950050D550551500907A5055990010105055000060555095990040557001000050155099590054154010400055555D555500000015055900014015069500454015056900850015A050004540150D6500015125045500112115054100125115014100114095004200004000405000000001010000010009004000F57F05007400555509007400155805005500254809405D001500155645000540099645000150D53471000140E534710000D8030000D801000CD809000C0000000CC089A860C021B266D81FB166180E0006003E9200000000000050000000000000000C0000000C0000000A0000000A0000B80F0000A00F0000F80F0000F80F00010000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000AAAAAAAA0000A3AAAA4AAAAAAAAA0900A0AAAAAA0A0000000000000000000A0000000000000000000A7065000000000000080A0000000000000000000A0000000000000000000A0000000000000000000A0000000000000000000A0000000000000000000A00000000000000000010B16BBB8B050000000000000200FFFFFFFF01004D00B7FBB6FB00000000000000000000000000000000000007000000030004000B00120018000400000000000000000000000000000000000C00010008000F0004000400040001000000000000000000000000000000000000000400000001000000000005000000030000000000030000000013";
    public static final String L2 = "0555455555000055010000005555065405007401005001004049454101000054454101004001005001005405005405001041650105001405140010000010295414000050155514001405541510001041011055005605006515000000005405005555155001005756164001000000005005009D95155415001101500000001102540000000110510410000554521410004508801A1600450450141000050090041000051050000000455102061900455055056500858049096A00455000026500455144411900051040510000410040014000410040055000020000155500111151155000111151054000010040010000005D010000005555065805005401005001004049454101000054454101004001005001005405005405001041650105001405140010000010295414000050155514001405541510001041011055005605006715000000005405005555255001005756164003000000005005009D95155415000555455555004C00140040008400150040000044140144000195140544001102A0864500110114054400010018014400010414004000519480414600115455415900216052825A0011248040590051145150460001045014400010005000500010005001540000004045550044445405540044446401500000005000400000000000000000000003000000030000180081A8180020B2000010B13E0000003E0032923E0606007E0656003E0006003E0002003E400000070000000700000000000000FF030000FF030000000000000000000000000000000000000000000000000000000000000000A0AAAA00000000000000A0AAAA000000000000E0AFAAAB00000000000000A0AAAA00000000000000A0AAAA0000000000000000000000000000200000030000000000000000000000000C000000009000000000000000000000000000000000000D100080000000000000000000700000000000000000006000000000000000000050000000000000000000000040000000000000000000000000000000000000000000000000000000000000000010BBB1BB82B5BBBB00000100610062000300FFFFFFFFFFFF000000000000B5FBB9FBB8FB5F00600000000A00200024000B0029002B002D0008000400000012002F0032008A008A0000000000050005000F000100010001000200010000000400040004000500050007000000000005000000080000000000050000000A0000000000050000000013";
    public static final String L3 = "15151515150015151515150000001900000019191919190000000000000015151515150015155515150000005001000019199403190000008004000015154109150015159515150000000000000019191919190000000000000015151515150015151515150000000000000019191919190000000000000000000000000043435743430041416A414100414141414100C1C1C1C1C100000000000000434305504300414105554100414145694100C1C15551C100000091500000434341434300414141414100414141414100C1C1C1C1C100000000000000434343434300414141414100414141414100C1C1C1C1C100151515151500000025000000191919191900000000000000151515151500151555151500000050010000191994031900000080040000151542091500151555151500000000000000191919191900000000000000151515151500151515151500000000000000191919191900000000000000151515151500000000000000D0D0D9D0D000505056505000505050505000707070707000000000000000D05001D4D000505041555000505051565000707065547000004014140000D050D0D0D000505050505000505050505000707070707000000000000000D0D0D0D0D00050505050500050505050500070707070700000000000777707007777070077770700777787A8000020B2770017B177100700770837927708070000005000777707007777070077770700777707000000000077770700777707007777070077770700003000400040008000300000000002000000000000000000000000000000000000000000000000000000000000000000000000A000900040009000400000000000000000000000000000000000000000000000000000000000000000000000000000000000900080070000A000300000000000000000000000000000000000000000000000000000000050000000000000000000000000300080001000A00040000000000000000000000000000000000000000000000000000000000000000000000000000000001041C286BB0B000000000200040000000000050003000000FFFFFFFFFFFF0000000000000000000000000F0012000000080004000100040039003B003D0000000000000000000000000010000A000000030028000D000100010001000100000000000000000000000F00000000000A0000000E00000000000A0000001400000000000A000A000000";
    public static final String L4 = "505501000000501500000000602500000000206055551500206055510500602500500900501500000800000000500900000000540500000000000100555555150100555565150100605D52000000200002590000200002040000200002000000200002000000205056550500205056551500605D02000000000000000000906A00000000505000000000905080004000505000A45A00906A00145400000000145400000000A45A0000000040560000000040530029002880560090AA9642510050140581510050140514500050140500500050140500500090140500500050F40108400050140500000090AA06000000501500000000602500000000206055551500206055510500602500500900501500000800000000500900000000540500000000000100555555150100555555150100605D52000000200002590000200002040000200002000000200002000000205056550500205056551500609D02000000505501000000000000000000A41A00000000141400000000141420001000141400A91600A41A00051500000000051700000000AA16000000009015000000005014000A000AA05500A4AA55501400144541601400144501051400144501001400144501001400148501001400147D00021000144501000000A4AA01000000000000007C000000440000004400000044C083A87C0022B2000012B100C00300000031920000000003005100FC7D000004710000042100000401000004010000040100008400000004010000FC01000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000A80900000700003200010000000000BC660600000000000000006656000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000D000000000000000000000000000000000000000000000010BBBB8CB8BBBBB100000300FFFF0200FFFFFFFFFFFF00000000FFFF6400FFFF64005F0005006300000008003F00430049004B000000040009004D00500058006B00850000008A0000000100010009000100010064000100040001000500010002000500000005001400000000000A0000001900000000000A0000001E00000000000A0001000100";
    public static final String L5 = "555555550400075045140400963000410400895041100400540100410400559255110400546195410400B443407004000430011004007455024014005457D5110000400501600A00180041500500000014002000550644000000120013A02A00100001901500504955411400A08A99010400541500100400410468284100615558145900191D5414410001755414590029571817410009040010590019145117410059551414590059151514410001301014490085500014490045500504500085504055550049900C555500615050545500655005545500E5500014090065150090590005504454410001C0442459000750451404009630004104004950411004005401004108005692551104005461954104007443407004000430011004007455024014005457D5110000400501600900180043600600000014001000550644000000120011A02A00100001501500504555411400A08A9901040054150010040055555555040010011A4A5000581516455600460715455000401D15455600CA15C64550000201004456000645D4455000561505455600564505455000000C04455200211400455200115401015400211450555500122441555500181414555500195401A56A0039140045420059050054560001141175500000301149560000020000C0010200C001000080010200921180A8000022B2C21410B1561C0200161D3092001C0600861F5600BE1E0400BE170400BE110000BC1B0000BCDE0700BC1F00003C000200801F0000801F0200010000000000000000000000000000006000000000000000000060000000000000000000600000000000000000006000000000003000666666000000000000000000600000000000000000006000000000000000020060000000000000000000600000000500004044446400000000000040404404000000000000404404040000000000004004000400000000000040444004000000000000404044040000000000004044440400000000000000000000000000000000000000000000000000000000000000000010418A25000000000000040006000000000000000000000000000000000000000000000000000000000007000800000000000900000008000000000000000000000000000000000000001100080000000000040000000500000000000000000000000000000000001E000A0001000A0023001E000A0002000A0023001E000A0003000A001E000100";
    public static final String L6 = "5555555575005415505520000440561500009819A82A20000005000020001808981900001407545520004A35509502005055541520005055541510005A15008412005454000420001010141500005014141520005014001A000010502610200054155055200057D55F55030003C00C002300D557545F750001802000040025912000550015115555550045404544050045514544550085550500550045C00500050011000560040021000080540091008566F40005004561550005054565050095650500050005004555550095054561550005856062050001802000540085491526550045C5351507000000000000005415505520000440561500009819A82A20000005000020001808981900001407545520004A35509502005055541520005055541510005A15008412005454000420001010141500005014141520005014001A000010502610200054155055200055555755010003C00C002300D557545F65005555555575000020080041004924084055004544555555001150115141005154115155006155014055001170014041000440011841000800002055002440A1197D0001405158550041415159410065590140410001405155550065415158550041219858410000200800550061528549550051714DC5410000000000000080030000BE0304003E7E0400067E0000067E84A8200024B2000010B1038001000380359207A6010000065400002600004400000000760400044604008043000080030400E7CE0500E7CE01000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000300000000000000000002050000000000000000030000000000000000000000000000004000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000001021840B00000000000005000700000000000000FFFF0000000000000000000000000000000000000000080013000800000009009F00000000000000000000000000000000000000000008000000060000000400010000000000000000000000000000000000000028000A0001000A00230028000A0002000A00230028000A0003000A0023000200";
    public static final String L7 = "54455551150001005500400060009E0007009000A60000005000AA03050000801503000055CD1573550055CC55735500560C82409500580E82802500680100402900580282B0250056018230950055CD5533550055CD5473550000C05402000050C0AA0006003000AA0000005000960005000100550040000450021640000150A9150000D1515515110051515515210001509910000001F0C03F000000000000000001FF00BC0000A5428A566A00955600545A00955600545A00A5568A066A0001F800FC030000000000000001F00F3C00000110981500009152551515005151651535000150A915000004500216400002005500400060009E0005006000A60000005000AA03050000801503000055CD1573550055CC55735500560C82409500580E82802500680100402900580282B0250056018230950055CD5533550055CD5473550000C05402000050C0AA0006003000AA00000050009600050001005500400054455551150001948005100000546A054000D45455454400645455454400005426044000003CF00F4000000000000000C03F002F4000A990A2955A00A51500955600A51500955600A995A2815A00003E00FF400000000000000000FC030F4000000466054000A45455454500545459454D0000546A054000019480053000811F0800801000008C1003008C100300800080A8801720B2000010B12FC00F00014938922140080021405800210908003F400F0000000000801E0000001000008C1003008C10030080100000811F08000000000000000000001000000000D0000000000000000000E00000008800000000000C000000880000000000000B0000000000000060000000000000000000000000500000000000000000000000007000000000093000000000000000000000000000000A0000000000000000000000000002000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001061646A25B8BB0C000006000800070000000700000007000000000000000000000000000400000000000800000000000000060000000C00000008000900A600A700A80000000000000008000000130000000D0000001300000007000400010001000100510000002D000A0001000A0023002D000A0002000A0023002D000A0003000A002300FFFF";
    public static final String L8 = "5555555555000054551500000051550500004044550100000041410400000000811400000040440000000041510100004556555555004156555555000541010055000100014055000000001500000001550400004044550100000051550500000054551500005555555555000000000000000000000000001000004000001004004000001011005000005044005800005001844900005001414500005041144400005006004000005008000000005006004000005441044000005041018000005041014900005044005800001011005000001004008000001000004000000000000000000000000000000000000000000054551500000051550500004044550100000041410400000000811400000040440000000041510100004556555555004156555555000541010055000100014055000000001500000001550400004044550100000051550500000054551500005555555555000000000000000000000000005554555555000400001000000401001000004404001400001411001600005400611200005440501100005410051100009C0100100000340200000000940100100000551001100000545000200000545040120000141100160000440400140000040100100000040000100000000000000000000000000000000000000000000000000000000000000000801F0000001E80A8001F20B2811D10B1100000001800309210000000800150008000000080100000801F0000000000000000000000000000000000000000000000000000110000000000001011111100000000000010111111000000000000101111110000000000001011111100000000000010111111000000000000101111160000000000001011111100000000000010111100000000000000000000000000000000000000008300000000000000000088005000000000708888880000000000008088888800000000000080888888000000000000808888880000000000008088888800000000000080888844444444444444444444444444444444444444444444444444444444444440856966050000000000000000000000000008000800080000000000000000000000000000000000000000000000090000001200050013000000000000000000000000000000000000000000000004000000030005000E000000000000000000000000000000000032000A0001000A00230032000A0002000A002300320003000A000A0023000000";
    public static final String L9 = "000000000000000000000000541555551500504900000000405555560900000050570400010050145800050000004000190050245000014051554000190000000000094052554000050040154000048001001000100004001500008015400100441500000100000000000000541501001500000000000000004001000000004001000000849045884800141088444400540000055400540010004500580000458500440000454500480010001500444004005400494004005400504014001500444054405500444054404500444068404A0054400400440084040400410044080400410000400100000000400100000000000000000050155555150050490000000040555556090000005055040001005014580005000000400019005024500001405155400019000000000009405255400005004015400004800100100010000400150000801540010044150000010000000000000054150100150000000000000000000000000000500000000000500000000021641122120005042211110015004001150015000440110016004051210011004051110012000440050011100100150012100100550014100540050011101550150011101550110011101A901200151001001100210101401000110201401000005000000000005000000000800000008000000080FE070000FE0700000084A8000026B2006010B1006000000600309286010000800150008001000080010000800100008001060080010600F8010700F8010700800000008000000033333303333333333333333333033333333333330300000000000000003003000000000000000030033033333333303303300330333333000000033000303333333300000300003033333333000003000032333333000000030000303303303333330300013033033033333303000030330330000000030003303303303033030330033033033030330303300330330300303303003003303303303333330330030000003033333300300300000030333333003033333303333333333333333333033333333333338063000000000000000000000A0001000000000000000000000000000000000000000000000000000000090000000500000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000037000A0001000A00230037000A0002000A00230037000A0003000A0023000000";
    public static final String L10 = "55001555550014500054000001400010640000001500150000050000450040151504000000001415000054500000100010400101540000405114500000500004040000000000050000055001500040055441000000005510140050010004040054500501050054404540150000411559000001500501000001014101040045114205050040514155410040510055000041400055510001004141550001000500550005110400050054510005050055111448150055011554210055011554100054100550000014000114010014000445450004040451510000152055400004565014000004111001010005010004010014500054000001400010640000001500150000050000450040151504000000001415000054500000100010400101540000405114500000500004040000000000050000055001500040055441000000005510140050010004040054500501050054404540150000411559000001500501000055001555550040405000410051845041410050545055100050144015000010104055540000405050550000400140550041040140410055144041010055040552450055400555480055400515440015440114000005400045000005004151110001014154140040054815100081151405000041044440000041000041400000070E0000070E000007000000000000000080A8000020B2000010B10000000000003092001C0C00001C5C00001C0C000000000000000000000E0000000E0000000C00000E0000000EE000000EE000000800FFFF00F100000020FC0FFF0000F0F0FF0070FF0FFFF007F0F0F000F0FF0FFFF0FFFFF0F9FFFFFF0F00F0FFFFF0F0000FFFFFFFFF00F000F0000FFFFFFFFFF0FFFFFF000F0F00FF00F0FFFFFF00000F0FFFF0FFFFF7FFF0FF0F0FFF00F00000F0F000070FFFFFF040F0F000300F0FFFFFF000F0F0FF070F0F00FFF0FFFFF0FFFF0FFFFFFF0000F000FFFF0FFFFFFF0F60F00F0FF00F00F0FF0F00000FFFF0FFFFF00000000F0F00F00FB0FAF0FFF70FFFFFFF0F00FF0000FF0700FFFF0C00FFFFFFFF5F00FFFF60666666BBCB069000000A000A000A000A000A000A000A00FFFFFFFFFFFFFFFF000000000000000000000E00130011000A000900050000008C0099009D00000000000000000000000000020004000E00050012000C0000000100010001006000000000000000000046000A0001000A0023004A000A0001000A002300560000000000090000000000";

    public static final String[] LEVELS = new String[]{L1, L2, L3, L4, L5, L6, L7, L8, L9, L10};

    private final List<Message> messages = new ArrayList<>();

    public enum Type {
        FLOOR(124, ' '),
        DOOR(271, 'D'),
        DARKNESS(62, '~'),
        SPELL_BLOCK(690, 'S'),
        STAIRS_UP(51, '^'),
        STAIRS_DOWN(50, 'v'),
        ELEVATOR(194, 'E'),
        PITFALL(683, 'P'),
        CHUTE(575, 'C'),
        SPINNER(688, 'S'),
        MESSAGE(596, 'M'),
        GUARDIAN(192, 'G'),
        MONSTER(59, 'X'),
        SPECIAL(59, 'Q'),
        TELEPORTER(689, 'T'),
        ROCK(387, 'R'),
        WALL(322, '+'),
        NORTH_WALL(282, '+'),
        SOUTH_WALL(242, '+'),
        HIDDEN_NORTH(327, '@'),
        HIDDEN_SOUTH(327, '@'),
        HIDDEN_WEST(327, '@'),
        HIDDEN_EAST(327, '@');
        private final int id;
        private final char dis;

        private Type(int id, char dis) {
            this.id = id;
            this.dis = dis;
        }

        public int id() {
            return this.id;
        }

        public char display() {
            return this.dis;
        }
    };

    public static void main(String[] args) throws Exception {
        new LwjglApplication(new WizardryMapTmxConvert());
    }

    @Override
    public void create() {

        try {

            Andius a = new Andius();
            a.create();

            for (String hx : MSGS) {
                messages.add(new Message(DatatypeConverter.parseHexBinary(hx)));
            }

            for (int i = 0; i < 1; i++) {
                MazeLevel level = new MazeLevel(DatatypeConverter.parseHexBinary(LEVELS[i]), i + 1);
                System.out.println("Level " + i);
                System.out.println(level);
                //Formatter fmtter = new Formatter(3 * 20, 3 * 20, level);
                //FileUtils.writeStringToFile(new File("target/WizLevel" + level.level + ".tmx"), fmtter.toString());
            }

        } catch (Exception e) {
            e.printStackTrace();
        }

        System.out.println("DONE");
    }

    @Override
    public void resize(int width, int height) {
    }

    @Override
    public void render() {
    }

    @Override
    public void pause() {
    }

    @Override
    public void resume() {
    }

    @Override
    public void dispose() {
    }

    class MazeLevel {

        public int level;
        byte[] buffer;
        MazeCell[][] cells = new MazeCell[20][20];

        public MazeLevel(byte[] buffer, int level) {
            this.level = level;
            this.buffer = buffer;

            for (int row = 0; row < 20; row++) {
                for (int column = 0; column < 20; column++) {
                    cells[row][column] = getLocation(row, column);
                }
            }
        }

        private MazeCell getLocation(int row, int column) {
            MazeAddress address = new MazeAddress(level, row, column);
            MazeCell cell = new MazeCell(address);

            // doors and walls
            int offset = column * 6 + row / 4; // 6 bytes/column

            int value = intValue(buffer[offset]);
            value >>>= (row % 4) * 2;
            cell.westWall = ((value & 1) == 1);
            value >>>= 1;
            cell.westDoor = ((value & 1) == 1);

            value = intValue(buffer[offset + 120]);
            value >>>= (row % 4) * 2;
            cell.southWall = ((value & 1) == 1);
            value >>>= 1;
            cell.southDoor = ((value & 1) == 1);

            value = intValue(buffer[offset + 240]);
            value >>>= (row % 4) * 2;
            cell.eastWall = ((value & 1) == 1);
            value >>>= 1;
            cell.eastDoor = ((value & 1) == 1);

            value = intValue(buffer[offset + 360]);
            value >>>= (row % 4) * 2;
            cell.northWall = ((value & 1) == 1);
            value >>>= 1;
            cell.northDoor = ((value & 1) == 1);

            // monster table
            offset = column * 4 + row / 8; // 4 bytes/column, 1 bit/row
            value = intValue(buffer[offset + 480]);
            value >>>= row % 8;
            cell.monsterLair = ((value & 1) == 1);

            // stairs, pits, darkness etc.
            offset = column * 10 + row / 2; // 10 bytes/column, 4 bits/row
            value = intValue(buffer[offset + 560]);
            int b = (row % 2 == 0) ? value % 16 : value / 16;
            int c = intValue(buffer[760 + b / 2]);
            int d = (b % 2 == 0) ? c % 16 : c / 16;

            switch (d) {
                case 1:
                    cell.stairs = true;
                    cell.addressTo = getAddress(b);
                    break;
                case 2:
                    cell.pit = true;
                    break;
                case 3:
                    cell.chute = true;
                    cell.addressTo = getAddress(b);
                    break;
                case 4:
                    cell.spinner = true;
                    break;
                case 5:
                    cell.darkness = true;
                    break;
                case 6: {
                    if (level == 9) {
                        cell.rock = true;
                    } else {
                        cell.teleport = true;
                        cell.addressTo = getAddress(b);
                    }
                    break;
                }
                case 8:
                    cell.elevator = true;
                    cell.elevatorTo = intValue(buffer[800 + b * 2], buffer[801 + b * 2]);
                    cell.elevatorFrom = intValue(buffer[832 + b * 2], buffer[833 + b * 2]);
                    cell.addressTo = getAddress(row, column);
                    break;
                case 9:
                    cell.rock = true;
                    break;
                case 10:
                    cell.spellsBlocked = true;
                    break;
                case 11:
                    int messageNum = intValue(buffer[800 + b * 2], buffer[801 + b * 2]);
                    for (Message m : messages) {
                        if (m.match(messageNum)) {
                            cell.message = m;
                            break;
                        }
                    }
                    if (cell.message == null) {
                        System.out.println("message not found : " + messageNum);
                    }
                    cell.messageType = intValue(buffer[832 + b * 2], buffer[833 + b * 2]);

                    int itemID = -1;

                    if (cell.messageType == 2) // obtain Item
                    {
                        itemID = intValue(buffer[768 + b * 2], buffer[769 + b * 2]);
                        cell.itemObtained = itemID;
                    }
                    if (cell.messageType == 5) // requires Item
                    {
                        itemID = intValue(buffer[768 + b * 2], buffer[769 + b * 2]);
                        cell.itemRequired = itemID;
                    }
                    if (cell.messageType == 4) {
                        value = intValue(buffer[768 + b * 2], buffer[769 + b * 2]);
                        if (value <= 100) {
                            cell.monsterID = value;
                        } else {
                            int val = (value - 64536) * -1;
                            cell.itemObtained = val; // check this
                        }
                    }
                    break;
                case 12:
                    cell.monsterID = intValue(buffer[832 + b * 2], buffer[833 + b * 2]);
                    break;
                default:
                    cell.unknown = d;
                    break;
            }

            return cell;
        }

        private MazeAddress getAddress(int b) {
            return new MazeAddress(
                    intValue(buffer[768 + b * 2], buffer[769 + b * 2]),
                    intValue(buffer[800 + b * 2], buffer[801 + b * 2]),
                    intValue(buffer[832 + b * 2], buffer[833 + b * 2]));
        }

        private MazeAddress getAddress(int x, int y) {
            return new MazeAddress(0, x, y);
        }

        @Override
        public String toString() {
            char[][] map = new char[60][60];
            for (int y = 0; y < 20; y++) {
                for (int x = 0; x < 20; x++) {
                    MazeCell cell = cells[x][y];
                    cell.draw();
                    for (int j = 0; j < 3; j++) {
                        for (int k = 0; k < 3; k++) {
                            Type t = cell.block[j][k];
                            map[x * 3 + j][y * 3 + k] = t != null ? t.display() : ' ';
                        }
                    }
                }
            }
            String ret = "";
            for (int x = 59; x >= 0; x--) {
                for (int y = 0; y < 60; y++) {
                    ret += map[x][y];
                }
                ret += "\n";
            }
            return ret;
        }

    }

    class MazeAddress {

        public final int level;
        public final int row;
        public final int column;

        public MazeAddress(int level, int row, int column) {
            this.level = level;
            this.row = row;
            this.column = column;
        }

        @Override
        public String toString() {
            return level + "/" + row + "/" + column;
        }
    }

    class MazeCell {

        Dimension cellSize = new Dimension(22, 22); // size in pixels

        boolean northWall;
        boolean southWall;
        boolean eastWall;
        boolean westWall;

        boolean northDoor;
        boolean southDoor;
        boolean eastDoor;
        boolean westDoor;

        boolean darkness;

        boolean stairs;
        boolean pit;
        boolean spinner;
        boolean chute;
        boolean elevator;
        boolean monsterLair;
        boolean rock;
        boolean teleport;
        boolean spellsBlocked;

        int elevatorFrom;
        int elevatorTo;

        int messageType;
        int monsterID = -1;
        int itemID;

        int unknown;

        MazeAddress address;
        MazeAddress addressTo; // if teleport/stairs/chute

        public Message message;
        public int itemRequired;
        public int itemObtained;

        Type[][] block = new Type[3][3];

        public MazeCell(MazeAddress address) {
            this.address = address;
        }

        public void draw() {

            if (darkness) {
                fill(Type.DARKNESS);
            }

            if (spellsBlocked) {
                fill(Type.SPELL_BLOCK);
            }

            if (rock) {
                fill(Type.ROCK);
            }

            /*
            Walls
             */
            if (northWall) {
                this.block[2][0] = Type.NORTH_WALL;
                this.block[2][1] = Type.NORTH_WALL;
                this.block[2][2] = Type.NORTH_WALL;
            }

            if (southWall) {
                this.block[0][0] = Type.SOUTH_WALL;
                this.block[0][1] = Type.SOUTH_WALL;
                this.block[0][2] = Type.SOUTH_WALL;
            }

            if (eastWall) {
                this.block[0][2] = Type.WALL;
                this.block[1][2] = Type.WALL;
                this.block[2][2] = Type.WALL;
            }

            if (westWall) {
                this.block[0][0] = Type.WALL;
                this.block[1][0] = Type.WALL;
                this.block[2][0] = Type.WALL;
            }

            /*
            Doors
             */
            if (northDoor) {
                this.block[2][0] = Type.WALL;
                this.block[2][1] = Type.DOOR;
                this.block[2][2] = Type.WALL;
            }

            if (eastDoor) {
                this.block[0][2] = Type.WALL;
                this.block[1][2] = Type.DOOR;
                this.block[2][2] = Type.WALL;
            }

            if (westDoor) {
                this.block[0][0] = Type.WALL;
                this.block[1][0] = Type.DOOR;
                this.block[2][0] = Type.WALL;
            }

            if (southDoor) {
                this.block[0][0] = Type.WALL;
                this.block[0][1] = Type.DOOR;
                this.block[0][2] = Type.WALL;
            }

            /*
            hidden doors
             */
            if (northDoor && northWall) {
                this.block[2][0] = Type.WALL;
                this.block[2][1] = Type.HIDDEN_NORTH;
                this.block[2][2] = Type.WALL;
            }

            if (eastDoor && eastWall) {
                this.block[0][2] = Type.WALL;
                this.block[1][2] = Type.HIDDEN_EAST;
                this.block[2][2] = Type.WALL;
            }

            if (westDoor && westWall) {
                this.block[0][0] = Type.WALL;
                this.block[1][0] = Type.HIDDEN_WEST;
                this.block[2][0] = Type.WALL;
            }

            if (southDoor && southWall) {
                this.block[0][0] = Type.WALL;
                this.block[0][1] = Type.HIDDEN_SOUTH;
                this.block[0][2] = Type.WALL;
            }

            if (monsterLair) {
                this.block[1][1] = Type.GUARDIAN;
            }

            if (monsterID >= 0) {
                this.block[1][1] = Type.MONSTER;
            }

            if (stairs) {
                if (address.level < addressTo.level) {
                    this.block[1][1] = Type.STAIRS_DOWN;
                } else {
                    this.block[1][1] = Type.STAIRS_UP;
                }
            }
            if (message != null) {
                this.block[1][1] = Type.MESSAGE;
            }
            if (pit) {
                this.block[1][1] = Type.PITFALL;
            }
            if (chute) {
                this.block[1][1] = Type.CHUTE;
            }
            if (spinner) {
                this.block[1][1] = Type.SPINNER;
            }
            if (teleport) {
                this.block[1][1] = Type.TELEPORTER;
            }
            if (elevator) {
                this.block[1][1] = Type.ELEVATOR;
            }
            if (unknown != 0) {
                this.block[1][1] = Type.SPECIAL;
            }
        }

        private void fill(Type id) {
            for (int x = 0; x < 3; x++) {
                for (int y = 0; y < 3; y++) {
                    block[x][y] = id;
                }
            }
        }

    }

    private static int nextMsgId = 0;

    class Message {

        protected String message;
        private final int id;
        private int totalLines;
        List<String> lines = new ArrayList<>();
        byte[] buffer;

        public Message(byte[] buffer) {
            this.id = nextMsgId;
            this.buffer = buffer;
            int recordLength = 42;
            StringBuilder text = new StringBuilder();

            for (int ptr = 0; ptr < buffer.length; ptr += recordLength) {
                nextMsgId++;
                totalLines++;
                String line = getLine(ptr).replace("\"", "");
                text.append(line + " ");
                lines.add(line);
            }
            text.deleteCharAt(text.length() - 1);
            message = text.toString().toLowerCase();
        }

        public boolean match(int messageNum) {
            if (id == messageNum) {
                return true;
            }

            // this code is to allow for a bug in scenario #1
            if (messageNum > id && messageNum < (id + totalLines)) {
                return true;
            }

            return false;
        }

        public String getText() {
            return message;
        }

        protected String getLine(int offset) {
            int length = intValue(buffer[offset]);
            return getString(buffer, offset + 1, length);
        }

    }

    public static final String M1 = "1F41204C41524745205349474E204F4E205448452057414C4C2052454144533A00000B4C454154480000212020202A2A2A20434F525249444F52204F5554204F46204C494D495453202A2A2AD7B20280CCCA00001820202020202020202020202020205455524E204241434B21A40CC680BA01A6013AD7B20280CCCA0100";
    public static final String M2 = "244120535452414E474520474C4F57205345454D5320544F20454D414E4154452046524F4D524FCA0000255448495320524F4F4D2E2020494E205448452043454E5445522C204120534D414C4C495348CCCA0000244D414E20494E2041204C4F4E4720524F4245205455524E5320544F57415244532054484580CCCA000011504152545920414E442053484F5554532C3AB20280CCCA39A40CC680BA01A6013AD7B20280CCCA000017202020224245474F4E452C20535452414E47455253212239A40CC680BA01A6013AD7B20280CCCA0000244845205448454E20424547494E5320574156494E47204849532048414E44532C20414E4480CCCA000012494E544F4E45532054484520574F5244532CB20280CCCA39A40CC680BA01A6013AD7B20280CCCA00001A202020224D415049524F204D4148414D41204449524F4D415422C680BA01A6013AD7B20280CCCA0100";
    public static final String M3 = "22594F55205345452041204C4152474520535441545545204F46204120484F4F444544B20280CCCA00002248554D414E4F49442E20205448455245204953204120474F4C44454E204C49474854B20280CCCA000024434F4D494E472046524F4D204120484F4C4520494E2054484520484F4F442E202054484580CCCA0000255354415455452049532042454A4557454C454420574954482050524543494F555320414E44CCCA00002553454D4950524543494F55532053544F4E45532E2020494E2046524F4E54204F4620544845CCCA00002453544154554520495320414E20414C5441522C2046524F4D20574849434820465245534880CCCA000013494E43454E5345204953204255524E494E472E0280CCCA39A40CC680BA01A6013AD7B20280CCCA0100";
    public static final String M4 = "2357495448494E2054484520524F4F4D204953204120535441545545545445204F4620410280CCCA000021535452414E474520424541535420574954482054484520424F4459204F46204120D7B20280CCCA000023434849434B454E20414E44205448452048454144204F462041204341542E20205448450280CCCA000025535441545545204953204D414445204F462042524F4E5A452C20414E44204C494553204F4ECCCA000024414E204F4E595820504544455354414C2E202054484552452041524520554E555355414C80CCCA00001A52554E4553204F4E204120504C415155452054484552454F4E2EC680BA01A6013AD7B20280CCCA0100";
    public static final String M5 = "24494E205448495320524F4F4D20495320412053494C56455220535441545545204F46204180CCCA000023424F4152205749544820484F524E5320414E44204C4F4E472046414E47532E20204F4E0280CCCA0000235448452057414C4C20425920544845205354415455452049532041204D4553534147450280CCCA000024285041525449414C4C59204F42534355524544292054484154204150504541525320544F80CCCA00002448415645204245454E204C4546542042592050415353494E4720454C5645532E2020495480CCCA000024495320484152444C59204C454749424C452C2042555420534F4D4520434F4D4D454E545380CCCA0000235741524E494E472041424F55542047484F53545320414E442044454D4F4E532043414E0280CCCA0000125354494C4C204245204D414445204F55542EB20280CCCA39A40CC680BA01A6013AD7B20280CCCA0100";
    public static final String M6 = "2041532054484520504152545920454E54455253205448495320524F4F4D2C20413AD7B20280CCCA00001E42524F4E5A452D434F4C4F52454420534D4F4B452046494C4C532049542EA6013AD7B20280CCCA00002653554444454E4C592C20544845205041525459204645454C5320434F4D50454C4C454420544FCA0000214C454156452054484520524F4F4D205448452057415920544845592043414D452ED7B20280CCCA0100";
    public static final String M7 = "2041532054484520504152545920454E54455253205448495320524F4F4D2C20413AD7B20280CCCA00002653494C5645525920464F472044455343454E44532046524F4D20544845204345494C494E472ECA00002353554444454E4C592C20494D41474553204F46205445525249424C452044454D4F4E5345204FCA0000225345454D20544F20464F524D20414C4C2041524F554E44205448454D2E202054484520464C45CA0000265041525459204D454D4245525320464C45452054484520524F4F4D20494E20544552524F522ECA0100";
    public static final String M8 = "204120504C4143415244204E454152205448452047524F554E442052454144533A4D20494E80CCCA00001522412044554E47454F4E2753204441524B2E2E2E22CCCA39A40CC680BA01A6013AD7B20280CCCA0100";
    public static final String M9 = "204120504C4143415244204E454152205448452047524F554E442052454144533A3AD7B20280CCCA000016225748454E2049542753204E4F54204C49542E2E2E22CA39A40CC680BA01A6013AD7B20280CCCA0100";
    public static final String M10 = "204120504C4143415244204E454152205448452047524F554E442052454144533A3AD7B20280CCCA000019225741544348204F55542C204F5220594F55274C4C2E2E2E220CC680BA01A6013AD7B20280CCCA0100";
    public static final String M11 = "215448455245204953204120535441545545545445204F4620412042454152204F4ED7B20280CCCA0000264120534D414C4C20504544455354414C2E2020424548494E442049542049532041205349474ECA00002452454144494E472C20224927564520474F542041204D494C4C494F4E204F462027454D2280CCCA0100";
    public static final String M12 = "2155504F4E204120534D414C4C2053494C56455259204449534B205245535453204141B20280CCCA000022535441545545204F4620412046524F472057454152494E4720412052454420414E4449455342CA000023424C554520434150452E2020414C54484F554748204D414445204F46204D4554414C2C204F46CA0000255448452053544154554520494E4558504C494341424C59205345454D5320544F20434F4D45CCCA000022544F204C4946452C205348414B494E472049545320464F52454C4547532046524F4D53494445CA00001E5349444520544F20534944452C204143434F4D50414E49454420425920412D50495443484544CA00001B484947482D504954434845442C202259454148212121212E2E2E22204C494553204F4E2041CCCA0100";
    public static final String M13 = "1F54484520464C4F4F52204841532041204D4F534149432052454144494E473A425920410280CCCA00000C225455524E204C4546542E22414C20415552412E80CCCA39A40CC680BA01A6013AD7B20280CCCA0100";
    public static final String M14 = "1F54484520464C4F4F52204841532041204D4F534149432052454144494E473A013AD7B20280CCCA00000D225455524E2052494748542E2200CC3AC63AB20280CCCA39A40CC680BA01A6013AD7B20280CCCA0100";
    public static final String M15 = "1F54484520464C4F4F52204841532041204D4F534149432052454144494E473A013AD7B20280CCCA00000E225455524E2041524F554E442E22CC3AC63AB20280CCCA39A40CC680BA01A6013AD7B20280CCCA0100";
    public static final String M16 = "1941205349474E204F4E2054484520444F4F522052454144533A0CC680BA01A6013AD7B20280CCCA0000262A2A2A2054455354494E472047524F554E445320434F4E54524F4C2043454E544552202A2A2ACA0000232020544849532041524541204953205354524943544C59204F46462D4C494D4954532E0280CCCA00001C20202020202020203C3C3C20444F204E4F5420454E544552203E3E3EBA01A6013AD7B20280CCCA0100";
    public static final String M17 = "2553554444454E4C592C2041204C4F55442050454E4554524154494E4720434C414E47494E47CCCA0000224F462042454C4C532043414E2042452048454152442E2020544845524520495320414C454E43CA00002153554444454E2053494C454E4345204153205448452042454C4C532053544F502C5245414B49CA000025464F4C4C4F5745442042592054484520434C414E4B494E4720414E442054524F4D50494E4754CA0000254F4620475541524449414E204D4F4E53544552532E20205448452050415254592047455453CCCA0000265448452049444541205448415420544845592041524520494E204249472054524F55424C4521CA0100";
    public static final String M18 = "1941205349474E204F4E2054484520444F4F522052454144533A0CC680BA01A6013AD7B20280CCCA000016225452454153555245205245504F5349544F52592E22CA39A40CC680BA01A6013AD7B20280CCCA0100";
    public static final String M19 = "1941205349474E204F4E2054484520444F4F522052454144533A0CC680BA01A6013AD7B20280CCCA00001B224D4F4E5354455220414C4C4F434154494F4E2043454E5445522280BA01A6013AD7B20280CCCA0100";
    public static final String M20 = "1941205349474E204F4E2054484520444F4F522052454144533A0CC680BA01A6013AD7B20280CCCA00001D202020202020202020202020205052495641544520454C455641544F5201A6013AD7B20280CCCA00001F202020202020202020415554484F52495A4544205553455253204F4E4C5921013AD7B20280CCCA0100";
    public static final String M21 = "03202020001300B80211B9ECC60200CC3AC63AB20280CCCA39A40CC680BA01A6013AD7B20280CCCA0000022020CD001300B80211B9ECC60200CC3AC63AB20280CCCA39A40CC680BA01A6013AD7B20280CCCA0000224556455259424F445920494E2054484520504152545920504153534553204F555421B20280CCCA0000022020CD001300B80211B9ECC60200CC3AC63AB20280CCCA39A40CC680BA01A6013AD7B20280CCCA000021414654455220412054494D452C2054484520504152545920434F4D455320544F2ED7B20280CCCA0000264645454C494E47204D554348205745414B454E45442C205448452050415254592046494E4453CA0000205448454D53454C564553204F5554534944452054484520444F4F5220544845593AD7B20280CCCA00000F545249454420544F20454E5445522E3AC63AB20280CCCA39A40CC680BA01A6013AD7B20280CCCA0100";
    public static final String M22 = "1E20202020494E205448495320313020425920313020524F4F4D2C20594F5520594F55200280CCCA0000204E4F54452041204C415247452053454D492D43495243554C4152204445534B2E5749544880CCCA00001F55504F4E20495420415245205448452052454D41494E53204F46205748415454442041424F55CA0000234D494748542048415645204245454E2053435259494E4720474C415353455320414E444C53CCCA00001E414D554C455453204F462053554D4D4F4E494E4720414E44204F54484552205345454D494E47CA000023415254494641435453204F4620434F4E54524F4C20414E44204B4E4F574C454447452E0280CCCA000024554E464F5254554E4154454C592C205448455920414C4C205345454D20544F204841564580CCCA0000254245454E2044455354524F594544204245594F4E44205245504149522E2020415320544845CCCA000021504152545920454E54455245442054484520524F4F4D2C204120534C4944494E4741525459000000002450414E454C204F4E20544845204C4546542057414C4C20534C414D4D454420534855542EEAD78600002553484F52544C592041465445522C20495420474C4F57454420412050414C4520424C55452EDFAA0000224E4F204D454D424552204F4620544845205041525459205741532041424C4520544F4FD7AAD5AA00000C505259204954204F50454E2E4152545920544F57415244532049542E000000000040ABD5AAB50000002320202020205448454E2C2054484520444F4F52204F4E20544845204F50504F534954450300000000002153494445204F462054484520524F4F4D20424547494E5320544F20474C4F5720418C0000000000000023425249474854204F52414E47452C205345454D494E4720544F204245434B4F4E20544F000000F600002654484520504152545920544F20434F4D452E2020415320544845205041525459205455524E53DD00002641424F55542C2054484559204E4F544943452054484520444F4F522057484943482054484559000000194841442055534544204841532044495341505045415245442E8C00000000000060BED88F0000000100";
    public static final String M23 = "26202020202041532054484520504152545920454E544552532054484520524F4F4D2C2054484500000025444F4F5220534C414D5320534855542C20474C4F575320425249474854204F52414E47452C0000000026414E4420444953415050454152532E20204120444F4F52204150504541525320544F205448450000001F52494748542E20204120564F4943452C20434F4D494E472046524F4D204E4F204F46464943452A0000244150504152454E5420444952454354494F4E2043414E2042452048454152442E202049542A552A000025534159533A202022434F4E47524154554C4154494F4E532C204D59204C4F59414C20414E443366000021574F52544859205355424A454354532E202020544F44415920594F552048415645737B4C197301000020534552564544204D452057454C4C20414E44205452554C592050524F56454E20E6CC99F301009E000024594F555253454C4620574F52544859204F462054484520515545535420594F55204152459EB3E60000114E4F5720544F20554E44455254414B452ECC99B3E6CC0100E6CC99B3E6CC99F301009EB3E6CC9900002520202020205345564552414C2059454152532041474F2C20414E20414D554C455420574153B3E600002353544F4C454E2046524F4D2054484520545245415355525920425920414E204556494CB3E6CC0100002457495A4152442057484F20495320505552504F5254454420544F20424520494E2054484500000000002344554E47454F4E20494D4D4544494154454C592042454C4F5720574845524520594F55000000000000224E4F57205354414E442E20205448495320414D554C45542048415320504F574552530000000000000025574849434820574520415245204E4F5720494E2044495245204E454544204F462E202049545C2A000025495320594F555220515545535420544F2046494E44205448495320414D554C455420414E44552A00001D52455452494556452049542046524F4D20544849532057495A4152442E7701001E33664C19336600002520202020494E205245434F474E4954494F4E204F4620594F555220475245415420444545447301000025544F4441592C20492057494C4C204749564520594F55204120424C554520524942424F4E2C009E00001F5748494348204D4159204245205553454420544F2041434345535320544845CC99F301009EB3E60000204C4556454C205452414E53504F52544552204F4E205448495320464C4F4F522E01009EB3E6CC99000025574954484F55542049542C2054484520504152545920574F554C4420424520554E41424C45B3E6000023544F20454E5445522054484520524F4F4D20494E205748494348204954204C4945532EB3E6CC010000222020202020474F204E4F572C20414E4420474F4420535045454420494E20594F555200000000000000075155455354212200000000000000000000000000000000000000000000000000000000000000000100";
    public static final String M24 = "1F202041204C4152474520534C4944494E472057414C4C2057495448205448450000000000000000000022494D414745204F46204120424541522055504F4E20495420424C4F434B5320544845000000000000002350415448204F46205448452050415254592E20205448452057414C4C20534C494445530000000000001F544F5741524453205448452050415254592C20464F5243494E47205448454D00000000000000000000114F5554534944452054484520524F4F4D2E000000000000000000000000000000000000000000000100";
    public static final String M25 = "242020204E4F424F445920494E205448452050415254592043414E20425245414B2054484500002000000A444F4F5220444F574E2E00000000000008012000000000000000280028000000000000002000480100";
    public static final String M26 = "25494E53435249424544204F4E20414E204F524E41544520474F4C4420504C415155452049532B0000002641204D4553534147452E202054484520534352495054204953204F524E4154452C1520414E440500001E424C494E4B5320494E20564152494F55532042524947485420485545533A36776E5D3B4719020000000120776E1D660800342F776E5D3B77180B006D6B5D3B776E5D662C007B2A552A552A551A330100000000264245204954204B4E4F574E205448415420594520415245205452455350415353494E47204F4E000000255448452050524F5045525459204F462054484520415243482D4D41474520574552444E412E00000000245448455245204953204E4F20504F535349424C452057415920544841542059452043414E000000000025504F535349424C5920474554205448524F554748204D5920444546454E5345532C204C45540000000026414C4F4E4520444546454154204D4520494E20424154544C45212020534F205355524520414D0000002449204F46205448495320544841542049204749564520594F55205448495320434C55452C00000000001C20202020202022434F4E5452412D444558545241204156454E554522000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000000000000000000000F5053202D20545245424F52205355580000000000000000000000000000000000000000000000000100";
    public static final String M27 = "254F4E452047524F5550204F4620475541524449414E5320594520484156452042454154454E0000000022425554204D414E59204D4F52452041574149542059452120205455524E204241434B000000000000001D5748494C4520594F55205354494C4C2043414E2C204D4F5254414C5321000000000000000000000100";
    public static final String M28 = "1941205349474E204F4E205448452057414C4C2052454144533A00000000000000000000000000000000222020224C414952204F4620544845204556494C2057495A41524420574552444E4122450000000000001C20202020202020205448452057495A415244204953202A2A494E2A2A5245204953204E4F0000000100";
    public static final String M29 = "2553554444454E444C5920594F552053454520412047524F5550204F4620332048554D414E2D00000000264F4944532E20204F4E4520495320412042415242415249414E205749544820412053574F5244000000265448415420474C4F57532C204F4E45204953204120534558592046454D414C45204D4147452C00000025414E4420544845205448495244204C4F4F4B53204C494B4520412048554745204F4752452100000000265448452042415242415249414E20504F494E545320544F2054484520454E44204F462054484500000023434F525249444F5220414E442059454C4C532022415249454C2E2E204F4F4B4C412E2E00000000000021544849532057415921212220414E44205448455920414C4C2052554E204F4646210000000000000100";
    public static final String M30 = "1D4954532047455454494E47205741524D2041524F554E44204845524521000000000000000000000100";
    public static final String M31 = "174954532047455454494E47205245414C4C5920484F5421000000000000000000000000000000000100";
    public static final String M32 = "1B49545320414C4D4F535420544F4F20484F5420544F2042454152210000000000000000000000000100";

    public static final String[] MSGS = new String[]{M1, M2, M3, M4, M5, M6, M7, M8, M9, M10, M11, M12, M13, M14, M15, M16, M16, M17, M18, M19, M20, M21, M22, M23, M24, M25, M26, M27, M28, M29, M30, M31, M32};

    private static int intValue(byte b1) {
        return b1 & 0xFF;
    }

    private static int intValue(byte b1, byte b2) {
        return intValue(b1) + intValue(b2) * 256;
    }

    private static String getString(byte[] buffer, int offset, int length) {
        StringBuffer text = new StringBuffer();

        for (int i = offset; i < offset + length; i++) {
            int c = intValue(buffer[i]);
            if (c > 127) {
                if (c < 160) {
                    c -= 64;
                } else {
                    c -= 128;
                }
            }
            if (c == 13) {
                text.append("\n");
            } else if (c < 32) // non-printable
            {
                text.append(".");
            } else // standard ascii
            {
                text.append((char) c);
            }
        }
        return text.toString();
    }

    public static class Formatter {

        int level;
        int mapWidth;
        int mapHeight;
        Type[][] ids;
        int[][] creatureIcons;
        int objectId = 0;
        Random rand = new Random();
        StringBuilder monsters = new StringBuilder();
        StringBuilder portals = new StringBuilder();
        StringBuilder messageProps = new StringBuilder();

        public Formatter(int mapWidth, int mapHeight, MazeLevel level) {
            this.mapWidth = mapWidth;
            this.mapHeight = mapHeight;
            this.level = level.level;
            this.ids = new Type[mapHeight][mapWidth];
            this.creatureIcons = new int[mapHeight][mapWidth];

            for (int r = 0; r < 20; r++) {
                for (int c = 0; c < 20; c++) {
                    MazeCell cell = level.cells[r][c];
                    cell.draw();
                    for (int x = 0; x < 3; x++) {
                        for (int y = 0; y < 3; y++) {
                            this.ids[r * 3 + x][c * 3 + y] = cell.block[x][y];
                            if (x == 1 && y == 1) {
                                portals.append(portal(cell,
                                        this.ids[r * 3 + x][c * 3 + y],
                                        (c) * (3 * 48) + (1 * 48),
                                        (20 - r) * (3 * 48) - (2 * 48)
                                ));
                                messageProps.append(messages(cell,
                                        (c) * (3 * 48) + (1 * 48),
                                        (20 - r) * (3 * 48) - (2 * 48)
                                ));
                                monsters.append(monster(cell,
                                        (c) * (3 * 48) + (1 * 48),
                                        (20 - r) * (3 * 48) - (2 * 48),
                                        r * 3 + x, c * 3 + y
                                ));
                            }
                        }
                    }
                }
            }

            for (int r = 19; r >= 0; r--) {
                for (int c = 0; c < 20; c++) {
                    MazeCell cell = level.cells[r][c];
                    if (cell.block[2][1] == Type.HIDDEN_NORTH || cell.block[2][1] == Type.DOOR) {
                        int j = r + 1 > 19 ? 0 : r + 1;
                        int k = c;
                        MazeCell adj = level.cells[j][k];
                        if (adj.block[0][1] == Type.SOUTH_WALL || adj.block[0][1] == Type.WALL) {
                            hidden((c) * (3 * 48) + (1 * 48), (20 - r) * (3 * 48) - (3 * 48), k * 3 + 1, (19 - j) * 3 + 1);
                        }
                    }
                    if (cell.block[0][1] == Type.HIDDEN_SOUTH || cell.block[0][1] == Type.DOOR) {
                        int j = r - 1 < 0 ? 19 : r - 1;
                        int k = c;
                        MazeCell adj = level.cells[j][k];
                        if (adj.block[2][1] == Type.NORTH_WALL || adj.block[2][1] == Type.WALL) {
                            hidden((c) * (3 * 48) + (1 * 48), (20 - r) * (3 * 48) - (1 * 48), k * 3 + 1, (19 - j) * 3 + 1);
                        }
                    }
                    if (cell.block[1][0] == Type.HIDDEN_WEST || cell.block[1][0] == Type.DOOR) {
                        int j = r;
                        int k = c - 1 < 0 ? 19 : c - 1;
                        MazeCell adj = level.cells[j][k];
                        if (adj.block[1][2] == Type.WALL) {
                            hidden((c) * (3 * 48) + (0 * 48), (20 - r) * (3 * 48) - (2 * 48), k * 3 + 1, (19 - j) * 3 + 1);
                        }
                    }
                    if (cell.block[1][2] == Type.HIDDEN_EAST || cell.block[1][2] == Type.DOOR) {
                        int j = r;
                        int k = c + 1 > 19 ? 0 : c + 1;
                        MazeCell adj = level.cells[j][k];
                        if (adj.block[1][0] == Type.WALL) {
                            hidden((c) * (3 * 48) + (2 * 48), (20 - r) * (3 * 48) - (2 * 48), k * 3 + 1, (19 - j) * 3 + 1);
                        }
                    }

                }
            }

        }

        private String monster(MazeCell cell, int x, int y, int r, int c) {
            if ((cell.monsterID >= 0 && cell.message == null) || cell.monsterLair) {

                return "";
            } else {
                return "";
            }
        }

        private String portal(MazeCell cell, Type type, int x, int y) {
            if (cell.teleport || cell.chute || cell.stairs || cell.elevator) {
                return String.format("<object id=\"%d\" name=\"%s\" x=\"%d\" y=\"%d\" width=\"48\" height=\"48\">\n"
                        + "   <properties>\n"
                        + "    <property name=\"dx\" value=\"%d\"/>\n"
                        + "    <property name=\"dy\" value=\"%d\"/>\n"
                        + "   </properties>\n"
                        + "  </object>",
                        ++objectId,
                        cell.elevator
                                ? "elevator levels " + cell.elevatorFrom + " to " + cell.elevatorTo
                                : type.toString().toLowerCase() + " to level " + cell.addressTo.level,
                        x, y, cell.addressTo.column * 3 + 1, (19 - cell.addressTo.row) * 3 + 1);

            } else {
                return "";
            }
        }

        private void hidden(int r, int c, int dx, int dy) {
            portals.append(String.format("<object id=\"%d\" name=\"%s\" x=\"%d\" y=\"%d\" width=\"48\" height=\"48\">\n"
                    + "   <properties>\n"
                    + "    <property name=\"dx\" value=\"%d\"/>\n"
                    + "    <property name=\"dy\" value=\"%d\"/>\n"
                    + "   </properties>\n"
                    + "  </object>",
                    ++objectId, "hidden door", r, c, dx, dy));
        }

        private String messages(MazeCell cell, int x, int y) {
            if (cell.message != null) {
                return String.format("<object id=\"%d\" name=\"%d\" type=\"%s\" x=\"%d\" y=\"%d\" width=\"48\" height=\"48\">\n"
                        + "   <properties>\n"
                        + "    <property name=\"messageType\" value=\"%d\"/>\n"
                        + "    <property name=\"monsterId\" value=\"%d\"/>\n"
                        + "    <property name=\"itemObtained\" value=\"%d\"/>\n"
                        + "    <property name=\"itemRequired\" value=\"%d\"/>\n"
                        + "   </properties>\n"
                        + "  </object>",
                        ++objectId,
                        cell.message.id,
                        cell.message.getText(),
                        x, y,
                        cell.messageType,
                        cell.monsterID,
                        cell.itemObtained,
                        cell.itemRequired);

            } else {
                return "";
            }
        }

        private int getWallId(Type t) {
            if (t == Type.SOUTH_WALL) {
                return getRandomBetween(302, 307);
            } else if (t == Type.NORTH_WALL) {
                return getRandomBetween(342, 347);
            } else if (t == Type.ROCK) {
                return getRandomBetween(382, 384);
            } else {
                return getRandomBetween(322, 326);
            }
        }

        private int getFloorId() {
            return getRandomBetween(122, 125);
        }

        private int getRandomBetween(int low, int high) {
            return rand.nextInt(high - low) + low;
        }

        @Override
        public String toString() {

            StringBuilder floor = new StringBuilder();
            StringBuilder doors = new StringBuilder();
            StringBuilder props = new StringBuilder();
            StringBuilder walls = new StringBuilder();
            StringBuilder creature = new StringBuilder();

            for (int r = mapHeight - 1; r >= 0; r--) {
                for (int c = 0; c < mapWidth; c++) {
                    if (ids[r][c] == Type.WALL || ids[r][c] == Type.ROCK || ids[r][c] == Type.NORTH_WALL || ids[r][c] == Type.SOUTH_WALL) {
                        walls.append(getWallId(ids[r][c])).append(",");
                    } else {
                        walls.append("0").append(",");
                    }
                }
                walls.append("\n");
            }
            walls.deleteCharAt(walls.length() - 2);

            for (int r = mapHeight - 1; r >= 0; r--) {
                for (int c = 0; c < mapWidth; c++) {
                    if (ids[r][c] == Type.DOOR || ids[r][c] == Type.HIDDEN_NORTH
                            || ids[r][c] == Type.HIDDEN_SOUTH || ids[r][c] == Type.HIDDEN_EAST || ids[r][c] == Type.HIDDEN_WEST) {
                        doors.append(ids[r][c].id()).append(",");
                    } else {
                        doors.append("0").append(",");
                    }
                }
                doors.append("\n");
            }
            doors.deleteCharAt(doors.length() - 2);

            for (int r = mapHeight - 1; r >= 0; r--) {
                for (int c = 0; c < mapWidth; c++) {
                    if (ids[r][c] == Type.MESSAGE || ids[r][c] == Type.DARKNESS || ids[r][c] == Type.CHUTE || ids[r][c] == Type.ELEVATOR
                            || ids[r][c] == Type.STAIRS_UP || ids[r][c] == Type.STAIRS_DOWN
                            || ids[r][c] == Type.TELEPORTER || ids[r][c] == Type.SPINNER) {
                        props.append(ids[r][c].id()).append(",");
                    } else {
                        props.append("0").append(",");
                    }
                }
                props.append("\n");
            }
            props.deleteCharAt(props.length() - 2);

            for (int r = mapHeight - 1; r >= 0; r--) {
                for (int c = 0; c < mapWidth; c++) {
                    if (ids[r][c] != Type.WALL && ids[r][c] != Type.ROCK && ids[r][c] != Type.NORTH_WALL) {
                        floor.append(getFloorId()).append(",");
                    } else {
                        floor.append("0").append(",");
                    }
                }
                floor.append("\n");
            }
            floor.deleteCharAt(floor.length() - 2);

            for (int r = mapHeight - 1; r >= 0; r--) {
                for (int c = 0; c < mapWidth; c++) {
                    if (ids[r][c] == Type.GUARDIAN || ids[r][c] == Type.MONSTER) {
                        creature.append(creatureIcons[r][c]).append(",");
                    } else {
                        creature.append("0").append(",");
                    }
                }
                creature.append("\n");
            }
            creature.deleteCharAt(creature.length() - 2);

            StringBuilder sb = new StringBuilder();
            for (int r = mapHeight - 1; r >= 0; r--) {
                for (int c = 0; c < mapWidth; c++) {
                    sb.append("0,");
                }
                sb.append("\n");
            }
            sb.deleteCharAt(sb.length() - 2);

            String template = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n"
                    + "<map version=\"1.0\" orientation=\"orthogonal\" renderorder=\"right-down\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\" tilewidth=\"48\" tileheight=\"48\" nextobjectid=\"1\">\n"
                    + " <properties>\n"
                    + "  <property name=\"startX\" value=\"1\"/>\n"
                    + "  <property name=\"startY\" value=\"58\"/>\n"
                    + " </properties>"
                    + " <tileset firstgid=\"1\" name=\"terrain\" tilewidth=\"48\" tileheight=\"48\" tilecount=\"760\" columns=\"20\">\n"
                    + "  <image source=\"uf_terrain.png\" width=\"960\" height=\"1824\"/>\n"
                    + "  <tile id=\"115\">\n"
                    + "   <animation>\n"
                    + "    <frame tileid=\"115\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"116\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"117\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"118\" duration=\"500\"/>\n"
                    + "   </animation>\n"
                    + "  </tile>\n"
                    + "  <tile id=\"135\">\n"
                    + "   <animation>\n"
                    + "    <frame tileid=\"135\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"136\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"137\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"138\" duration=\"500\"/>\n"
                    + "   </animation>\n"
                    + "  </tile>\n"
                    + "  <tile id=\"155\">\n"
                    + "   <animation>\n"
                    + "    <frame tileid=\"155\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"156\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"157\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"158\" duration=\"500\"/>\n"
                    + "   </animation>\n"
                    + "  </tile>\n"
                    + "  <tile id=\"175\">\n"
                    + "   <animation>\n"
                    + "    <frame tileid=\"175\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"176\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"177\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"178\" duration=\"500\"/>\n"
                    + "   </animation>\n"
                    + "  </tile>\n"
                    + "  <tile id=\"195\">\n"
                    + "   <animation>\n"
                    + "    <frame tileid=\"195\" duration=\"300\"/>\n"
                    + "    <frame tileid=\"196\" duration=\"300\"/>\n"
                    + "    <frame tileid=\"197\" duration=\"300\"/>\n"
                    + "    <frame tileid=\"198\" duration=\"300\"/>\n"
                    + "   </animation>\n"
                    + "  </tile>\n"
                    + "  <tile id=\"215\">\n"
                    + "   <animation>\n"
                    + "    <frame tileid=\"215\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"216\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"217\" duration=\"500\"/>\n"
                    + "    <frame tileid=\"218\" duration=\"500\"/>\n"
                    + "   </animation>\n"
                    + "  </tile>\n"
                    + "  <tile id=\"644\">\n"
                    + "   <animation>\n"
                    + "    <frame tileid=\"644\" duration=\"200\"/>\n"
                    + "    <frame tileid=\"645\" duration=\"200\"/>\n"
                    + "   </animation>\n"
                    + "  </tile>\n"
                    + "  <tile id=\"664\">\n"
                    + "   <animation>\n"
                    + "    <frame tileid=\"664\" duration=\"200\"/>\n"
                    + "    <frame tileid=\"665\" duration=\"200\"/>\n"
                    + "   </animation>\n"
                    + "  </tile>\n"
                    + "  <tile id=\"672\">\n"
                    + "   <animation>\n"
                    + "    <frame tileid=\"672\" duration=\"750\"/>\n"
                    + "    <frame tileid=\"673\" duration=\"750\"/>\n"
                    + "   </animation>\n"
                    + "  </tile>\n"
                    + "  <tile id=\"674\">\n"
                    + "   <animation>\n"
                    + "    <frame tileid=\"674\" duration=\"750\"/>\n"
                    + "    <frame tileid=\"675\" duration=\"750\"/>\n"
                    + "   </animation>\n"
                    + "  </tile>\n"
                    + " </tileset>\n"
                    + " <tileset firstgid=\"761\" name=\"heroes\" tilewidth=\"48\" tileheight=\"48\" tilecount=\"520\" columns=\"40\">\n"
                    + "  <image source=\"uf_heroes.png\" width=\"1920\" height=\"624\"/>\n"
                    + " </tileset>"
                    + "<layer name=\"floor\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\">\n"
                    + "  <data encoding=\"csv\">\n"
                    + "   %s\n"
                    + "  </data>\n"
                    + " </layer>\n"
                    + " <layer name=\"floor 2\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\">\n"
                    + "  <data encoding=\"csv\">\n"
                    + "   " + sb.toString()
                    + "  </data>\n"
                    + " </layer>\n"
                    + " <layer name=\"props\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\">\n"
                    + "  <data encoding=\"csv\">\n"
                    + "   %s\n"
                    + "  </data>\n"
                    + " </layer>\n"
                    + " <layer name=\"creature\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\">\n"
                    + "  <data encoding=\"csv\">\n"
                    + "   %s\n"
                    + "  </data>\n"
                    + " </layer>\n"
                    + " <layer name=\"water_edges\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\">\n"
                    + "  <data encoding=\"csv\">\n"
                    + "   " + sb.toString()
                    + "  </data>\n"
                    + " </layer>\n"
                    + " <layer name=\"shadows\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\">\n"
                    + "  <data encoding=\"csv\">\n"
                    + "   " + sb.toString()
                    + "  </data>\n"
                    + " </layer>\n"
                    + " <layer name=\"walls\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\">\n"
                    + "  <data encoding=\"csv\">\n"
                    + "   %s\n"
                    + "  </data>\n"
                    + " </layer>\n"
                    + " <layer name=\"door\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\">\n"
                    + "  <data encoding=\"csv\">\n"
                    + "   %s\n"
                    + "  </data>\n"
                    + " </layer>\n"
                    + " <layer name=\"torches\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\">\n"
                    + "  <data encoding=\"csv\">\n"
                    + "   " + sb.toString()
                    + "  </data>\n"
                    + " </layer>\n"
                    + " <layer name=\"webs\" width=\"" + this.mapWidth + "\" height=\"" + this.mapHeight + "\">\n"
                    + "  <data encoding=\"csv\">\n"
                    + "   " + sb.toString()
                    + "  </data>\n"
                    + " </layer>\n"
                    + " <objectgroup name=\"messages\">\n"
                    + "   %s\n"
                    + " </objectgroup>"
                    + " <objectgroup name=\"people\">\n"
                    + "   %s\n"
                    + " </objectgroup>"
                    + " <objectgroup name=\"portals\">\n"
                    + "   %s\n"
                    + " </objectgroup>"
                    + " <objectgroup name=\"rooms\">\n"
                    + "  <object id=\"1\" x=\"1584\" y=\"1824\">\n"
                    + "   <polygon points=\"0,0 0,240 336,240 336,0 240,0 240,-48 96,-48 96,0\"/>\n"
                    + "  </object>"
                    + " </objectgroup>"
                    + "</map>\n";

            return String.format(template, floor, props, creature, walls, doors, messageProps, monsters, portals);

        }
    }

}
